<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chicken Catching Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Comic Sans MS', 'Arial Rounded MT Bold', 'Arial', sans-serif;
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
            touch-action: manipulation;
        }
        
        body {
            background-color: #fff9c4; /* soft pale yellow */
            font-family: 'Comic Sans MS', 'Arial Rounded MT Bold', 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #gameContainer {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        
        #background {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        #staticChicken {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            width: 80px;
            height: auto;
        }
        
        #movingChicken {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            z-index: 15;
            width: 80px;
            height: auto;
        }
        
        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            display: flex;
            gap: 20px;
        }
        
        .btn {
            padding: 15px 30px;
            font-size: 18px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        #stopButton {
            background: linear-gradient(45deg, #ff9800, #ffc107); /* orange/yellow gradient */
            color: white;
        }
        
        #exitButton {
            background-color: #5d4037; /* dark brown */
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .btn:active {
            transform: translateY(1px);
        }
        
        #result {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 20;
            background-color: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 10px;
            display: none;
        }
        
        #tryAgainButton {
            padding: 10px 20px;
            font-size: 16px;
            background: linear-gradient(45deg, #4caf50, #8bc34a); /* green gradient */
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            margin-left: 10px;
            touch-action: manipulation;
            font-weight: bold;
        }
        
        #tryAgainButton:hover {
            background: linear-gradient(45deg, #388e3c, #689f38);
        }
        
        #orientationNotice {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #5d4037; /* dark brown */
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            font-size: 24px;
            text-align: center;
            padding: 20px;
            display: none;
        }
        
        #trialInfo {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 20px;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
            z-index: 20;
            background-color: rgba(0,0,0,0.5);
            padding: 10px 20px;
            border-radius: 10px;
        }
        
        /* Hide stop button on mobile */
        @media (max-width: 768px) {
            #stopButton {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <img id="background" src="bg1.jpg" alt="Background">
        <img id="staticChicken" src="chic100.png" alt="Static Chicken">
        <img id="movingChicken" src="chickentrans.png" alt="Moving Chicken">
        <div id="trialInfo">Tries Left: <span id="triesLeft">10</span></div>
        <div id="result">
            <span id="resultText"></span>
        </div>
        <div id="controls">
            <button id="stopButton" class="btn">STOP!</button>
            <button id="tryAgainButton">Try Again</button>
            <button id="exitButton" class="btn">EXIT</button>
        </div>
    </div>
    
    <div id="orientationNotice">
        <p>Please rotate your device to landscape mode</p>
        <p>For the best gaming experience</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const gameContainer = document.getElementById('gameContainer');
            const movingChicken = document.getElementById('movingChicken');
            const staticChicken = document.getElementById('staticChicken');
            const stopButton = document.getElementById('stopButton');
            const resultDiv = document.getElementById('result');
            const resultText = document.getElementById('resultText');
            const tryAgainButton = document.getElementById('tryAgainButton');
            const exitButton = document.getElementById('exitButton');
            const orientationNotice = document.getElementById('orientationNotice');
            const triesLeftElement = document.getElementById('triesLeft');
            
            let position = -200;
            let speed = 10;
            let gameRunning = true;
            let animationId = null; // Track animation frame ID
            
            // Check if user is logged in
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            // Set default settings if not already set
            if (!localStorage.getItem('trialSpeed')) {
                localStorage.setItem('trialSpeed', '10');
            }
            if (!localStorage.getItem('trialPrecision')) {
                localStorage.setItem('trialPrecision', '1');
            }
            if (!localStorage.getItem('loggedInSpeed')) {
                localStorage.setItem('loggedInSpeed', '10');
            }
            if (!localStorage.getItem('loggedInPrecision')) {
                localStorage.setItem('loggedInPrecision', '1');
            }
            
            // Load game settings from database
            fetch('/api/settings')
                .then(response => response.json())
                .then(settings => {
                    // Store settings in localStorage
                    localStorage.setItem('trialSpeed', settings.trialSpeed);
                    localStorage.setItem('trialPrecision', settings.trialPrecision);
                    localStorage.setItem('loggedInSpeed', settings.loggedInSpeed);
                    localStorage.setItem('loggedInPrecision', settings.loggedInPrecision);
                    
                    // Load game settings based on user status
                    if (isLoggedIn && user.payment_status === 'approved') {
                        // Use logged-in user settings
                        speed = parseInt(localStorage.getItem('loggedInSpeed')) || 10;
                    } else {
                        // Use trial mode settings
                        speed = parseInt(localStorage.getItem('trialSpeed')) || 10;
                    }
                })
                .catch(error => {
                    console.error('Error loading settings:', error);
                    // Use localStorage values or defaults
                    if (isLoggedIn && user.payment_status === 'approved') {
                        speed = parseInt(localStorage.getItem('loggedInSpeed')) || 10;
                    } else {
                        speed = parseInt(localStorage.getItem('trialSpeed')) || 10;
                    }
                });
            
            // Check orientation on load
            checkOrientation();
            
            // Determine if user is in trial mode or logged in
            let triesLeft;
            if (isLoggedIn && user.payment_status === 'approved' && user.game_chances !== undefined) {
                // Logged in user with approved payment
                triesLeft = user.game_chances;
            } else {
                // Trial mode - load from localStorage or default to 10
                triesLeft = parseInt(localStorage.getItem('chickenGameTries')) || 10;
            }
            
            triesLeftElement.textContent = triesLeft;
            
            // If no tries left, redirect appropriately
            if (triesLeft <= 0) {
                if (isLoggedIn && user.payment_status === 'approved') {
                    alert('No game chances left! Please contact support.');
                    window.location.href = 'index.html';
                } else {
                    alert('Trial mode completed! Register to play and win cash.');
                    window.location.href = 'register.html';
                }
                return;
            }
            
            let gameWidth = gameContainer.offsetWidth;
            let gameHeight = gameContainer.offsetHeight;
            let chickenWidth = 80;
            let chickenHeight = 80;
            let staticChickenRect = staticChicken.getBoundingClientRect();
            let staticChickenLeft = staticChickenRect.left - gameContainer.getBoundingClientRect().left;
            let staticChickenRight = staticChickenLeft + chickenWidth;
            let staticChickenTop = staticChickenRect.top - gameContainer.getBoundingClientRect().top;
            let staticChickenBottom = staticChickenTop + chickenHeight;
            
            // Position the static chicken
            staticChicken.style.left = '50%';
            staticChicken.style.top = '50%';
            staticChicken.style.transform = 'translate(-50%, -50%)';
            
            // Position the moving chicken initially
            movingChicken.style.left = '-200px';
            
            function updateGame() {
                if (!gameRunning) return;
                
                position += speed;
                movingChicken.style.left = position + 'px';
                
                // Reset position when chicken goes off screen
                if (position > gameWidth) {
                    position = -200;
                }
                
                animationId = requestAnimationFrame(updateGame);
            }
            
            function stopChicken() {
                if (!gameRunning) return;
                
                gameRunning = false;
                
                // Calculate positions relative to game container
                const movingChickenRect = movingChicken.getBoundingClientRect();
                const containerRect = gameContainer.getBoundingClientRect();
                const staticChickenRect = staticChicken.getBoundingClientRect();
                
                // Get precise positions
                const movingLeft = movingChickenRect.left - containerRect.left;
                const movingTop = movingChickenRect.top - containerRect.top;
                const staticLeft = staticChickenRect.left - containerRect.left;
                const staticTop = staticChickenRect.top - containerRect.top;
                
                // Load precision factor based on user status
                let precisionFactor = 1;
                if (isLoggedIn && user.payment_status === 'approved') {
                    // Use logged-in user precision
                    precisionFactor = parseFloat(localStorage.getItem('loggedInPrecision')) || 1;
                } else {
                    // Use trial mode precision
                    precisionFactor = parseFloat(localStorage.getItem('trialPrecision')) || 1;
                }
                
                // Check for overlap with precision factor
                const horizontalMatch = Math.abs(movingLeft - staticLeft) < precisionFactor;
                const verticalMatch = Math.abs(movingTop - staticTop) < precisionFactor;
                
                triesLeft--;
                triesLeftElement.textContent = triesLeft;
                
                // Save tries to localStorage or update user game chances
                if (isLoggedIn && user.payment_status === 'approved') {
                    // Update user game chances in localStorage
                    user.game_chances = triesLeft;
                    localStorage.setItem('user', JSON.stringify(user));
                    
                    // Update user game chances in the database
                    fetch('/api/user/update-chances', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userId: user.id,
                            gameChances: triesLeft
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            console.error('Failed to update game chances:', data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error updating game chances:', error);
                    });
                } else {
                    // Trial mode - save to localStorage
                    localStorage.setItem('chickenGameTries', triesLeft);
                }
                
                if (horizontalMatch && verticalMatch) {
                    resultText.textContent = 'You Win!';
                    resultText.style.color = '#44ff44';
                    
                    // Only redirect to winning page for logged-in users
                    if (isLoggedIn && user.payment_status === 'approved') {
                        // Record win in database immediately
                        fetch('/api/user/win', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                userId: user.id
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                console.error('Failed to record win:', data.error);
                                // Still redirect to winning page even if recording fails
                                setTimeout(() => {
                                    window.location.href = 'winning.html';
                                }, 2000);
                            } else {
                                console.log('Win recorded successfully');
                                // Redirect to winning page after a short delay
                                setTimeout(() => {
                                    window.location.href = 'winning.html';
                                }, 2000);
                            }
                        })
                        .catch(error => {
                            console.error('Error recording win:', error);
                            // Still redirect to winning page even if recording fails
                            setTimeout(() => {
                                window.location.href = 'winning.html';
                            }, 2000);
                        });
                    } else {
                        // For trial users, just show win message without redirect
                        setTimeout(() => {
                            resultText.textContent = 'You Win! (Trial Mode - No Prize)';
                            resultText.style.color = '#44ff44';
                        }, 2000);
                    }
                } else {
                    resultText.textContent = 'You Lose!';
                    resultText.style.color = '#ff4444';
                }
                
                resultDiv.style.display = 'block';
                
                // Check if game is over (only for losing cases)
                if (triesLeft <= 0 && !(horizontalMatch && verticalMatch)) {
                    setTimeout(() => {
                        if (isLoggedIn && user.payment_status === 'approved') {
                            alert('No game chances left! Please contact support.');
                            window.location.href = 'index.html';
                        } else {
                            alert('Trial mode completed! Register to play and win cash.');
                            window.location.href = 'register.html';
                        }
                    }, 2000);
                }
            }
            
            function tryAgain() {
                // Check if user has tries left
                if (triesLeft <= 0) {
                    if (isLoggedIn && user.payment_status === 'approved') {
                        alert('No game chances left! Please contact support.');
                        window.location.href = 'index.html';
                        return;
                    } else {
                        alert('Trial mode completed! Register to play and win cash.');
                        window.location.href = 'register.html';
                        return;
                    }
                }
                
                // Cancel any existing animation frames
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
                
                position = -200;
                movingChicken.style.left = position + 'px';
                gameRunning = true;
                resultDiv.style.display = 'none';
                updateGame();
            }
            
            function exitGame() {
                // Clear trial mode tries from localStorage when exiting
                localStorage.removeItem('chickenGameTries');
                // Redirect to homepage
                window.location.href = 'index.html';
            }
            
            function checkOrientation() {
                if (window.innerWidth < window.innerHeight) {
                    orientationNotice.style.display = 'flex';
                } else {
                    orientationNotice.style.display = 'none';
                }
            }
            
            // Touch event for mobile
            gameContainer.addEventListener('click', function(e) {
                // Only trigger on mobile devices
                if (window.innerWidth <= 768) {
                    stopChicken();
                }
            });
            
            // Space key for PC
            document.addEventListener('keydown', function(e) {
                if (e.code === 'Space') {
                    stopChicken();
                }
            });
            
            stopButton.addEventListener('click', stopChicken);
            tryAgainButton.addEventListener('click', tryAgain);
            exitButton.addEventListener('click', exitGame);
            window.addEventListener('resize', checkOrientation);
            
            // Start the game
            updateGame();
            
            // Handle window resize
            window.addEventListener('resize', () => {
                gameWidth = gameContainer.offsetWidth;
                gameHeight = gameContainer.offsetHeight;
                
                // Update static chicken position info
                staticChickenRect = staticChicken.getBoundingClientRect();
                staticChickenLeft = staticChickenRect.left - gameContainer.getBoundingClientRect().left;
                staticChickenRight = staticChickenLeft + chickenWidth;
                staticChickenTop = staticChickenRect.top - gameContainer.getBoundingClientRect().top;
                staticChickenBottom = staticChickenTop + chickenHeight;
            });
        });
    </script>
</body>
</html>